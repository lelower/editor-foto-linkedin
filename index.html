<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Foto LinkedIn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0077b5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-blue-50 min-h-screen text-slate-800">

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">
                <i class="fa-brands fa-linkedin text-[#0077b5] mr-2"></i>Editor de Foto Profissional
            </h1>
            <p class="text-slate-600">Transforme a sua selfie numa foto de perfil profissional com IA</p>
        </header>

        <!-- Main Interface -->
        <div class="glass-panel rounded-2xl shadow-xl p-6 md:p-8 bg-white">
            
            <!-- Upload Section -->
            <div id="uploadSection" class="mb-8 transition-all duration-300">
                <label for="imageInput" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-[#0077b5] transition-colors group">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <div class="p-3 bg-blue-50 rounded-full mb-3 group-hover:bg-blue-100 transition-colors">
                            <i class="fas fa-cloud-upload-alt text-2xl text-[#0077b5]"></i>
                        </div>
                        <p class="mb-1 text-sm text-slate-700 font-medium">Clique para carregar a sua foto</p>
                        <p class="text-xs text-slate-500">PNG, JPG (Máx. 5MB)</p>
                    </div>
                    <input id="imageInput" type="file" class="hidden" accept="image/*" />
                </label>
            </div>

            <!-- Editor Area (Hidden initially) -->
            <div id="editorArea" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Original Image -->
                <div class="flex flex-col space-y-3">
                    <h3 class="font-semibold text-slate-700 flex items-center">
                        <i class="fas fa-image mr-2 text-slate-400"></i>Original
                    </h3>
                    <div class="relative rounded-xl overflow-hidden bg-slate-100 border border-slate-200 aspect-square group shadow-inner">
                        <img id="previewImage" class="w-full h-full object-cover" src="" alt="Original">
                        <button onclick="resetApp()" class="absolute top-2 right-2 bg-white/90 p-2 rounded-full text-slate-600 hover:text-red-500 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity" title="Remover foto">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Generated Image -->
                <div class="flex flex-col space-y-3">
                    <h3 class="font-semibold text-slate-700 flex items-center">
                        <i class="fas fa-wand-magic-sparkles mr-2 text-[#0077b5]"></i>Resultado IA
                    </h3>
                    <div class="relative rounded-xl overflow-hidden bg-slate-100 border border-slate-200 aspect-square shadow-inner flex items-center justify-center">
                        <!-- Placeholder/Loading/Result -->
                        <div id="resultPlaceholder" class="text-center p-6">
                            <i class="fas fa-user-tie text-4xl text-slate-300 mb-3"></i>
                            <p class="text-sm text-slate-500">A sua foto profissional aparecerá aqui</p>
                        </div>
                        
                        <div id="loadingState" class="hidden flex flex-col items-center">
                            <div class="loading-spinner mb-4"></div>
                            <p class="text-sm font-medium text-slate-600 animate-pulse">A melhorar a imagem...</p>
                            <p class="text-xs text-slate-400 mt-1">Isto pode demorar alguns segundos</p>
                        </div>

                        <img id="resultImage" class="hidden w-full h-full object-cover" src="" alt="Resultado Profissional">
                        
                        <!-- Actions Overlay -->
                        <div id="resultActions" class="hidden absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/70 to-transparent flex justify-center gap-3">
                            <button onclick="downloadImage()" class="bg-white text-slate-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-100 transition-colors shadow-lg flex items-center">
                                <i class="fas fa-download mr-2"></i>Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div id="controlsSection" class="hidden mt-8 pt-6 border-t border-slate-100">
                <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div class="text-sm text-slate-500">
                        <i class="fas fa-info-circle mr-1"></i> A IA irá ajustar a iluminação, o fundo e o estilo.
                    </div>
                    <button id="generateBtn" onclick="generateProfessionalPhoto()" class="w-full md:w-auto bg-[#0077b5] hover:bg-[#006097] text-white px-8 py-3 rounded-xl font-medium shadow-lg shadow-blue-500/30 transition-all transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <span class="mr-2">Melhorar Foto</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                <div id="errorMessage" class="hidden mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorText">Ocorreu um erro.</span>
                </div>
            </div>

        </div>

        <div class="text-center mt-8 text-slate-400 text-xs">
            Powered by Gemini 2.5 Flash
        </div>
    </div>
<script>
    let currentBase64 = null;
    let currentMimeType = null;

    // DOM Elements
    const fileInput = document.getElementById('imageInput');
    const uploadSection = document.getElementById('uploadSection');
    const editorArea = document.getElementById('editorArea');
    const controlsSection = document.getElementById('controlsSection');
    const previewImage = document.getElementById('previewImage');
    const resultImage = document.getElementById('resultImage');
    const resultPlaceholder = document.getElementById('resultPlaceholder');
    const loadingState = document.getElementById('loadingState');
    const resultActions = document.getElementById('resultActions');
    const generateBtn = document.getElementById('generateBtn');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');

    // Event Listeners
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            showError("A imagem é demasiado grande. Por favor escolha uma imagem com menos de 5MB.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            // Salva apenas o conteúdo base64 sem o prefixo data:image/...
            currentBase64 = event.target.result.split(',')[1];
            currentMimeType = file.type;
            previewImage.src = event.target.result;
            
            uploadSection.classList.add('hidden');
            editorArea.classList.remove('hidden');
            controlsSection.classList.remove('hidden');
            hideError();
        };
        reader.readAsDataURL(file);
    }

async function generateProfessionalPhoto() {
    if (!currentBase64) return;

    setLoading(true);
    hideError();

    const prompt = "Maintain the person's facial features exactly as they are. Improve this photo for a professional LinkedIn headshot. Enhance lighting to studio quality, soft and flattering. Change the background to a blurred, neutral professional office. High resolution, 4k, professional photography.";

    try {
        const result = await callGeminiAPI(prompt, currentBase64, currentMimeType);
        
        // LOG para debug: veja o que chegou da Vercel no seu console (F12)
        console.log("Resposta da IA:", result);

        // O Gemini 2.0 Flash Experimental costuma devolver neste formato:
        if (result.candidates && result.candidates[0].content.parts) {
            const parts = result.candidates[0].content.parts;
            
            // Procuramos por qualquer parte que contenha 'inlineData' ou 'inline_data'
            const imagePart = parts.find(p => p.inlineData || p.inline_data);
            
            if (imagePart) {
                const imageData = imagePart.inlineData || imagePart.inline_data;
                const newImageBase64 = imageData.data;
                const mimeType = imageData.mimeType || 'image/png';
                
                resultImage.src = `data:${mimeType};base64,${newImageBase64}`;
                showResult();
            } else {
                // Se a IA não gerou imagem, ela pode ter devolvido um texto explicando o porquê
                const textMsg = parts.find(p => p.text)?.text || "A IA não devolveu uma imagem.";
                throw new Error(textMsg);
            }
        } else {
            throw new Error("Formato de resposta desconhecido. Verifique o console.");
        }

    } catch (error) {
        console.error("Erro completo:", error);
        showError("Erro: " + error.message);
    } finally {
        setLoading(false);
    }
}

async function callGeminiAPI(prompt, imageBase64, mimeType) {
    const payload = {
        contents: [{
            parts: [
                { text: prompt },
                { inlineData: { mimeType: mimeType, data: imageBase64 } }
            ]
        }],
        generationConfig: {
            // No Gemini 2.5, esta configuração é essencial para receber a imagem
            responseModalities: ["IMAGE"] 
        }
    };

    const response = await fetch('/api/processar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const result = await response.json();
    return result;
}

    // UI Helper Functions
    function setLoading(isLoading) {
        if (isLoading) {
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner !w-5 !h-5 !border-2 mr-2"></span> Processando...';
            resultPlaceholder.classList.add('hidden');
            resultImage.classList.add('hidden');
            resultActions.classList.add('hidden');
            loadingState.classList.remove('hidden');
        } else {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<span class="mr-2">Melhorar Foto</span><i class="fas fa-arrow-right"></i>';
            loadingState.classList.add('hidden');
        }
    }

    function showResult() {
        loadingState.classList.add('hidden');
        resultPlaceholder.classList.add('hidden');
        resultImage.classList.remove('hidden');
        resultActions.classList.remove('hidden');
    }

    function showError(msg) {
        errorText.textContent = msg;
        errorMessage.classList.remove('hidden');
    }

    function hideError() {
        errorMessage.classList.add('hidden');
    }

    function resetApp() {
        fileInput.value = '';
        currentBase64 = null;
        currentMimeType = null;
        previewImage.src = '';
        resultImage.src = '';
        uploadSection.classList.remove('hidden');
        editorArea.classList.add('hidden');
        controlsSection.classList.add('hidden');
        resultPlaceholder.classList.remove('hidden');
        resultImage.classList.add('hidden');
        resultActions.classList.add('hidden');
        hideError();
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'foto-linkedin-profissional.png';
        link.href = resultImage.src;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
